import React, { useState }  from 'react'
import { Box, Button, Flex, Image, Input, SimpleGrid, Text, Toast } from '@chakra-ui/react'


import { useToast } from '@chakra-ui/react'
import axios from 'axios'
import CartDetails from './CartDetails'
import { useEffect } from 'react'
import { useDispatch, useSelector } from 'react-redux'
import styles from "./CartDetails.module.css";
import { Link } from 'react-router-dom'
import { useNavigate } from 'react-router-dom'
import CartWithoutLogin from './CartWithoutLogin'

const Cart = () => {
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const [cartProducts, setCartProducts] = useState({});
  const { accessToken } = useSelector(store => store.auth);
  const { cartItems } = useSelector((store) => store.cart.cartItems);
  const toast = useToast();
  console.log(cartItems, "see");
  
  
  useEffect(() => {
    if (accessToken) {
      
      getCartData();
    }
  }, [])
 
  
  async function getCartData(){
    try {
      let res = await axios.get(`${process.env.REACT_APP_URL}/api/cart`, {
            headers: {
                authorization:accessToken
            }
      });
      console.log(res.data);
      setCartProducts(res.data);
    }
    catch (err) {
      console.log(err.message);
    }
  }


  async function deletCartItem(id) {
    try {
      await axios.delete(`${process.env.REACT_APP_URL}/api/cart/${id}`, {
            headers: {
                authorization:accessToken
            }
      });
      getCartData();
      toast({
        position: 'top',
        title: 'Item Deleted',
        description: 'Sad to see you going :(',
        status: 'warning',
        duration: 1500,
        isClosable: true,
      });
    }
    catch (err) {
      console.log(err.message);
    }
  }

  function deletCartItemWithoutLogin(id) {
    dispatch({ type: 'DELETE_CART_ITEMS', payload: { id: id } });
    toast({
      position: 'top',
      title: 'Item Deleted',
      description: 'Sad to see you going :(',
      status: 'warning',
      duration: 1500,
      isClosable: true,
    });
  }

  
  return (
    <>
      {accessToken &&
        (cartProducts.cart?.item.length > 0 ? (
          <Box mt={'7rem'} /*border="1px solid black"*/ mb="1%">
            {/* <Image width="100%" height="68px" src={adv} alt="image"  /> */}
            <Box mt="1%" width="100%">
              <Flex
                justifyContent={'space-between'}
                flexDir={['column', 'column', 'column', 'row']}
              >
                {/* Cart box */}

                <Box width={['100%', '100%', '100%', '70%']}>
                  {cartProducts.cart?.item.map((item) => {
                    const { _id } = item;
                    return (
                      <CartDetails
                        key={_id}
                        cartItem={item}
                        deletCartItem={deletCartItem}
                      />
                    );
                  })}
                </Box>

                {/* Amount description box */}

                <Flex
                  flexDir={'column'}
                  gap="12px"
                  width={['100%', '100%', '100%', '30%']}
                  position="sticky"
                  top="120px"
                  pl="1.5em"
                  pt="1em"
                  pr="1.5em"
                  borderRadius={'10px'}
                  mr="20px"
                  columnGap="10px"
                  height="500px"
                  boxShadow="rgba(67, 71, 85, 0.27) 0px 0px 0.25em, rgba(90, 125, 188, 0.05) 0px 0.25em 1em"
                >
                  <Text color="#bf9850">Having A Coupon?</Text>
                  <Flex gap="10px">
                    <Input
                      p="1.3em"
                      focusBorderColor="none"
                      placeholder="Enter Coupon code here"
                    ></Input>{' '}
                    <Button
                      p="1rem"
                      border={'1px solid #bf9850'}
                      bg="none"
                      color="#bf9850"
                    >
                      APPLY
                    </Button>
                  </Flex>
                  <Text fontSize={'20px'} fontWeight="600" mb="15px">
                    Order Details
                  </Text>
                  <Text>Total Products : {cartProducts?.total}</Text>
                  <Flex justifyContent={'space-between'} fontSize={'14px'}>
                    <Text fontWeight={'400'}>Bag total </Text>
                    <Text fontWeight={'600'}>
                      ₹{' '}
                      {cartProducts.cart?.subTotal
                        .toString()
                        .replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',')}
                    </Text>
                  </Flex>

                  <Flex justifyContent={'space-between'} fontSize={'14px'}>
                    <Text fontWeight={'400'}>Convenience Fee : </Text>
                    <Text fontWeight={'400'} color="#176c93" fontSize="14px">
                      ₹ 0
                    </Text>
                  </Flex>
                  <Flex justifyContent={'space-between'} fontSize={'14px'}>
                    <Text fontWeight={'400'}>Delivery Fee </Text>
                    <Text fontWeight={'600'}>₹ 0</Text>
                  </Flex>
                  <Flex justifyContent={'space-between'} fontSize={'14px'}>
                    <Text fontSize={'20px'} fontWeight={'600'}>
                      Total Amount
                    </Text>
                    <Text fontSize={'20px'} fontWeight={'600'}>
                      ₹{' '}
                      {(cartProducts.cart?.subTotal)
                        .toString()
                        .replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',')}
                      .00
                    </Text>
                  </Flex>

                  <Button
                    width="100%"
                    color="white"
                    bgColor="#d5a249"
                    fontWeight="600"
                    fontSize="1rem"
                    mt="15px"
                    p="1.5em"
                    _hover={{ bgColor: '#d5a249' }}
                    onClick={() => navigate('/address')}
                  >
                    PROCEED TO SHIPPING
                  </Button>
                </Flex>
              </Flex>
            </Box>
          </Box>
        ) : (
          <Box className={styles.cart_empty}>
            <Text fontWeight={'500'}>
              Don't Keep Your Cart Without HomeDecor !!
            </Text>
            <Link to="/furniture" className={styles.link_to_sign}>
              Do Shopping
            </Link>
          </Box>
        ))}
      {!accessToken &&
        (cartItems.length === 0 ? (
          <Box className={styles.cart_empty}>
            <Text fontWeight={'500'}>
              Don't Keep Your Home Without HomeDecor !!
            </Text>
            <Link to="/signin" className={styles.link_to_sign}>
              Sign-In
            </Link>
          </Box>
        ) : (
          <Box mt="1%" width="100%">
            <Flex
              justifyContent={'space-between'}
              flexDir={['column', 'column', 'column', 'row']}
            >
              <Box width={['100%', '100%', '100%', '70%']} mt={'7rem'}>
                {cartItems?.map((item) => {
                  const { _id } = item;
                  return (
                    <CartWithoutLogin
                      key={_id}
                      cartItem={item}
                      deletCartItem={deletCartItemWithoutLogin}
                    />
                  );
                })}
              </Box>
              <Flex
                flexDir={'column'}
                gap="12px"
                width={['100%', '100%', '100%', '30%']}
                position="sticky"
                top="120px"
                pl="1.5em"
                pt="1em"
                pr="1.5em"
                borderRadius={'10px'}
                mr="20px"
                columnGap="10px"
                height="500px"
                boxShadow="rgba(67, 71, 85, 0.27) 0px 0px 0.25em, rgba(90, 125, 188, 0.05) 0px 0.25em 1em"
              >
                <Text color="#bf9850">Having A Coupon?</Text>
                <Flex gap="10px">
                  <Input
                    p="1.3em"
                    focusBorderColor="none"
                    placeholder="Enter Coupon code here"
                  ></Input>{' '}
                  <Button
                    p="1rem"
                    border={'1px solid #bf9850'}
                    bg="none"
                    color="#bf9850"
                  >
                    APPLY
                  </Button>
                </Flex>
                <Text fontSize={'20px'} fontWeight="600" mb="15px">
                  Order Details
                </Text>
                <Text>Total Products : {cartItems?.length}</Text>
                <Flex justifyContent={'space-between'} fontSize={'14px'}>
                  <Text fontWeight={'400'}>Bag total </Text>
                  <Text fontWeight={'600'}>
                    ₹{' '}
                    {cartItems
                      ?.reduce((a, c) => a + c.price * c.quantity, 0)
                      .toString()
                      .replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',')}
                  </Text>
                </Flex>

                <Flex justifyContent={'space-between'} fontSize={'14px'}>
                  <Text fontWeight={'400'}>Convenience Fee : </Text>
                  <Text fontWeight={'400'} color="#176c93" fontSize="14px">
                    ₹ 0
                  </Text>
                </Flex>
                <Flex justifyContent={'space-between'} fontSize={'14px'}>
                  <Text fontWeight={'400'}>Delivery Fee </Text>
                  <Text fontWeight={'600'}>₹ 0</Text>
                </Flex>
                <Flex justifyContent={'space-between'} fontSize={'14px'}>
                  <Text fontSize={'20px'} fontWeight={'600'}>
                    Total Amount
                  </Text>
                  <Text fontSize={'20px'} fontWeight={'600'}>
                    ₹{' '}
                    {cartItems
                      ?.reduce((a, c) => a + c.price * c.quantity, 0)
                      .toString()
                      .replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',')}
                    .00
                  </Text>
                </Flex>

                <Button
                  width="100%"
                  color="white"
                  bgColor="#d5a249"
                  fontWeight="600"
                  fontSize="1rem"
                  mt="15px"
                  p="1.5em"
                  _hover={{ bgColor: '#d5a249' }}
                  onClick={() => navigate('/signin')}
                >
                  PROCEED TO SHIPPING
                </Button>
              </Flex>
            </Flex>
          </Box>
        ))}
    </>
  );
};

export default Cart